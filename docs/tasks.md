# 开发任务分解与实施计划

## 阶段里程碑规划
- Alpha（T0+4 周）
  - 完成基础网关骨架：Pingora 接入、Axum 路由、Sea-ORM 数据读写、Reqwest 上游调用
  - 实现核心功能：路由匹配、鉴权（API Key）、限流（每租户/每路由）
  - 引入基础缓存：路由/鉴权数据本地缓存，热更新机制（ArcSwap）
  - 可观测性：Tracing + Metrics 基线、错误码体系与结构化日志
  - 基本压测：目标 5K QPS，P99 ≤ 70ms（为Beta准备）

- Beta（T0+8 周）
  - 高可用性：集群部署、健康检查与故障转移、滚动升级与灰度发布
  - 完整限流/熔断/重试策略，支持上游隔离与降级
  - 数据模型完善：审计日志、按租户与服务分区策略，DDL 与索引优化
  - 可观测性强化：OTel 接入、Prometheus 指标细化、SLO告警配置
  - 压测达成：≥10K QPS，P99 ≤ 50ms（仿真生产流量模型）

- Release（T0+12 周）
  - 安全加固：认证/授权覆盖更多场景，密钥轮换流程与配置治理
  - 成本优化：连接池/线程/缓存参数按容量模型精调，自动伸缩策略落地
  - CI/CD 完整流水线：分支策略、质量门禁、发布审批与回滚预案
  - 运行SLO达标：99.99% 可用性，故障演练与值班流程

## 模块开发优先级排序
1) 网关核心与路由解析
2) 鉴权与多租户隔离
3) 限流/熔断/重试（稳定性）
4) 数据访问与缓存（性能）
5) 可观测性与告警（可靠性）
6) 健康检查与故障转移（HA）
7) 管理与配置API（运营）

## 关键技术验证 POC 清单
- POC-01：Pingora + Axum 协作性能基线（10K QPS目标）
  - 场景：短连接 vs 长连接、HTTP/1.1 vs HTTP/2，对比 P99 延迟
  - 指标：吞吐、尾延迟、CPU/内存、FD 使用率
- POC-02：Sea-ORM 连接池参数对吞吐的影响
  - 对比：`max_connections` 32/64/128/256；单事务与批量写
- POC-03：本地缓存（DashMap/Moka）命中率与一致性
  - 测试：TTL 与版本化热更新，命中率 ≥ 90% 的情况下延迟改善
- POC-04：限流与熔断策略稳定性
  - 对比：固定窗口/漏桶/令牌桶；请求风暴与上游故障情况下的服务可用性
- POC-05：上游调用（Reqwest）连接复用与超时策略
  - 测试：DNS 缓存、连接池大小与超时组合对尾延迟的影响

## 性能压测方案设计
- 压测工具与方法：
  - `wrk`, `bombardier`, `k6`（分布式压测，支持多租户与多路由场景）
  - 灰度场景：均衡/热点混合、读多写少与写放大两类路径
- 压测指标与SLO：
  - 吞吐：目标 ≥ 10K QPS（单实例或小规模集群）
  - 延迟：P50 ≤ 15ms，P95 ≤ 35ms，P99 ≤ 50ms
  - 错误率：≤ 0.1%，限流与熔断被视为“受控拒绝”不计入错误
  - 资源：CPU ≤ 70%，内存 ≤ 70%，FD 与连接池不发生枯竭
- 压测配置建议：
  - `TOKIO_WORKER_THREADS = CPU核心数`，`DB_POOL_MAX` 初始 64/128/256 三级对比
  - `HTTP_KEEPALIVE = true`，`READ/WRITE_TIMEOUT = 5s`，`IDLE_TIMEOUT = 30s`
  - 上游模拟：100–500 并发连接，返回大小 512B/2KB/16KB 分级
- 产出与验收：
  - 报告：曲线与表格（吞吐/延迟/CPU/内存/FD/池使用率）
  - 建议：参数调优与瓶颈定位（网络/CPU/锁/DB/上游）